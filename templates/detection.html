{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white flex flex-col items-center pt-10">

    <!-- Heading -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            AI Emotion Detection
        </h1>
        <p class="text-gray-400 mt-2">
            Real-time emotion detection using your camera
        </p>
    </div>

    <!-- Camera Box -->
    <div class="relative rounded-2xl overflow-hidden shadow-2xl border-4 border-blue-500/30">
        <video id="video" width="800" autoplay muted class="bg-black"></video>

        <!-- Emotion Badge -->
        <div class="absolute bottom-4 left-4 bg-black/70 px-5 py-2 rounded-full text-lg">
            Emotion:
            <span id="emotion" class="font-bold text-green-400">Detecting...</span>
        </div>

        <!-- Live Badge -->
        <div class="absolute top-4 right-4 bg-red-600 px-3 py-1 rounded-full text-xs animate-pulse">
            LIVE
        </div>
    </div>

    <!-- Stats -->
    <div class="mt-8 grid grid-cols-3 gap-6 w-full max-w-4xl px-4">
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center">
            <h3 class="text-xl font-bold text-blue-400">Camera</h3>
            <p>Browser</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center">
            <h3 class="text-xl font-bold text-green-400">Status</h3>
            <p>Running</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center">
            <h3 class="text-xl font-bold text-purple-400">Model</h3>
            <p>CNN Emotion Model</p>
        </div>
    </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
const video = document.getElementById("video");
const emotionText = document.getElementById("emotion");

// Start camera
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        alert("Camera access denied!");
        console.error(err);
    });

// Capture frame & send to backend
setInterval(() => {
    if (!video.videoWidth) return;

    const canvas = document.createElement("canvas");
    canvas.width = 48;
    canvas.height = 48;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, 48, 48);

    canvas.toBlob(blob => {
        fetch("/predict_emotion", {
            method: "POST",
            body: blob
        })
        .then(res => res.json())
        .then(data => {
            emotionText.innerText = data.emotion.toUpperCase();
        })
        .catch(err => console.error(err));
    }, "image/jpeg");

}, 1000);
</script>

{% endblock %}
